# v1.3.0 更新（2026-02-25）

更新摘要（重点）：
- 主要更新：提升离线与无后端场景下的可用性，优先使用本地缓存/已导入音频或 IndexedDB 回退，以在 IndexTTS 服务不可用时继续播放。
- 新增设置与迁移稳定性改进：优化了听书模式的播放逻辑，重构mini播放器前端。功能更加强大。

详细变更与迁移说明请参见：`UPDATE_REPORT.md`

---

# v1.2.0 更新（2026-02-24）

更新摘要（重点）：
- 主要更新：增强在**未启动 IndexTTS 服务**时的可用性 —— 优先使用本地缓存/已导入音频或 IndexedDB 回退，以在离线或无后端时继续播放。
- 新增设置控制项以精细化网络请求行为（`allowFetch` / `autoInfer`），可选择仅使用本地音频或允许回退到远端服务。

详细变更与迁移说明请参见：`UPDATE_REPORT.md`

# v1.1.0 更新（2026-02-14）

更新摘要：
 - 重构设置管理，新增预设（presets）支持与 `getRootSettings` / `switchPreset`
 - 集成本地目录（File System Access API）用于音频导入/导出与持久句柄保存
 - 增加提示词注入（Prompt Injection）功能，可在聊天生成时按深度插入自定义提示词
 - 扩展 IndexedDB：新增 `configs` store，支持保存本地目录句柄与额外配置
 - 播放与缓存逻辑增强：支持全局播放列表（playlist）、seek、自动推理控制与容错
 - 新增 `UPDATE_REPORT.md`（仓库根目录），包含详细变更说明与迁移建议

详细变更请参见：`UPDATE_REPORT.md`

# IndexTTS2 Player 🎙️

一个为 [SillyTavern](https://github.com/SillyTavern/SillyTavern) 设计的高级文本转语音（TTS）播放器扩展，支持智能角色配音、音声克隆、行内播放、多种解析模式等功能。

**版本**: 1.0.0 | **作者**: kirara

---

## 🎬 项目简介

**IndexTTS2 Player** 是一个为开源角色扮演聊天应用 **SillyTavern** 设计的高级文本转语音播放器扩展。它集成了强大的 **IndexTTS2 TTS 引擎**，为您的聊天体验增加了专业的语音朗读功能。

### 核心特色 🌟

| 特性 | 说明 |
|------|------|
| 🎙️ **多角色智能配音** | 为不同AI角色分别配置语音，自动匹配角色进行朗读 |
| 📚 **灵活解析模式** | GAL 模式（仅朗读对话）和听书模式（全文朗读）二选一 |
| 🖱️ **行内播放按钮** | 在对话文本中注入可点击的播放按钮，支持逐句播放 |
| ⚡ **迷你浮窗播放器** | 实时进度条、倍速调节、音量控制，使用体验媲美专业播放器 |
| 💾 **智能音频缓存** | 基于 IndexedDB 的持久化缓存，支持导入/导出本地音频库 |
| 🎯 **自动推理生成** | AI 回复后自动生成语音，无需手动点击即可享受配音 |
| 🔊 **音声克隆** | 上传音频样本快速克隆新语音，轻松定制角色音色 |

### 工作原理 🔄

```
用户输入
   ↓
AI 生成回复
   ↓
索引扩展检测消息
   ↓
调用 IndexTTS2 API 生成语音
   ↓
缓存到本地数据库
   ↓
用户点击播放或自动播放
   ↓
迷你播放器提供完整控制
```

### 适用场景 💡

- ✨ **沉浸式角色扮演** - 每个角色都有独特的语音，增强代入感
- 📖 **有声故事朗读** - 支持完整剧本式对话，营造真实场景感
- 🎮 **游戏剧情叙述** - 适合文字冒险游戏、互动故事等场景
- 🚗 **无手操作** - 支持自动播放，适合开车或其他无法看屏幕的场景
- ♿ **无障碍辅助** - 为视障用户提供完整的语音支持

### 演示视频


https://github.com/user-attachments/assets/4f1c4372-fd90-4389-ae66-70f506b5edb8



### 技术栈 🛠️

- **前端框架**: 原生 JavaScript（无依赖）
- **音频处理**: Web Audio API、IndexedDB
- **UI 框架**: 原生 DOM + CSS3（适配 SillyTavern UI）
- **后端集成**: IndexTTS2 API（任何兼容接口的 TTS 服务）

---

## 📋 目录

- [功能特性](#功能特性)
- [安装指南](#安装指南)
- [快速开始](#快速开始)
- [详细功能说明](#详细功能说明)
- [配置选项](#配置选项)
- [使用示例](#使用示例)
- [API 文档](#api-文档)
- [常见问题](#常见问题)
- [故障排除](#故障排除)

---

## 🎯 功能特性

### 核心功能

✅ **多角色智能配音**
- 为不同角色自动匹配对应的语音文件
- 支持角色语音映射表（VoiceMap）
- 快速切换和管理角色配音

✅ **灵活的文本解析模式**
- **GAL 模式**：仅朗读带 VN 格式标记的对话（如 `[角色]|「对话」`）
- **听书模式**：朗读整个消息内容，支持全文播放

✅ **行内播放增强**
- 在对话文本末尾注入可点击的播放按钮
- 支持逐句点击播放
- 可选的行内增强渲染切换

✅ **高级播放控制**
- 迷你播放器（Mini Player）悬浮窗
  - 进度条拖拽
  - 播放/暂停控制
  - 实时倍速调节
  - 自动隐藏
- 全局音量和速度控制
- 音频淡入/淡出平滑过渡

✅ **音频缓存系统**
- IndexedDB 本地缓存
- 支持导入/导出音频缓存
- 快速导入本地目录音频文件
- 缓存清空和管理功能

✅ **音声克隆**（Voice Cloning）
- 将用户上传的音频文件作为新的语音样本
- 自动转码（支持 WAV、MP3、OGG）
- 集成的克隆工作流

✅ **自动推理功能**（Auto Inference）
- 收到回复后自动生成语音
- 带有推理状态指示
- 可选的静默推理模式

✅ **消息控制按钮**
- 🔊 播放整层楼 - 按顺序播放该消息内所有台词
- ✨ 先推理后播放 - 先生成语音再播放
- ⚙️ 配置 - 快速打开配音配置面板

---

## 📦 安装指南

### 前置要求

1. **SillyTavern** 已安装并正常运行
2. **IndexTTS2 API 服务**（TTS 后端服务器）
   - 默认地址：`http://127.0.0.1:7880`
   - 需支持以下端点：
     - `POST /v1/audio/speech` - 文本转语音
     - `POST /api/v1/indextts2_cloning` - 音声克隆

### 安装步骤

1. **克隆或下载本扩展**

   ```bash
   git clone https://github.com/yourusername/st-indextts2.git
   ```

2. **复制文件到扩展目录**

   ```
   SillyTavern/public/scripts/extensions/third-party/st-indextts2/
   ├── index.js
   ├── manifest.json
   ├── style.css
   └── README.md
   ```

3. **在 SillyTavern 中启用扩展**
   - 打开 SillyTavern 主界面
   - 进入 **Extensions（扩展）** 管理面板
   - 找到 "IndexTTS2 Player"
   - 启用扩展

4. **配置 TTS 服务地址**
   - 打开扩展的 **设置面板**
   - 输入你的 IndexTTS2 服务地址（如：`http://127.0.0.1:7880/v1/audio/speech`）
   - 保存设置

---

## 🚀 快速开始

### 第一次使用

1. **启用扩展后**，在聊天界面每条机器人回复下方会出现三个新按钮：
   - 🔊 **播放整楼层** - 点击播放该条消息内所有台词
   - ✨ **先推理后播放** - 自动生成语音后播放
   - ⚙️ **配置** - 打开配音设置面板

2. **首次配置角色**：
   - 点击 ⚙️ **配置** 按钮
   - 在弹出的配置面板中添加角色及其对应的语音文件
   - 点击 **保存** 按钮

3. **开始播放**：
   - 点击 🔊 按钮播放整条消息
   - 或点击行内的小播放按钮播放单句

### 基础工作流

```
1. 用户提问
   ↓
2. AI 生成回复
   ↓
3. （可选）点击"先推理后播放"自动生成语音
   ↓
4. 点击"播放整楼层"或行内按钮播放语音
   ↓
5. 使用迷你播放器调整进度、倍速、音量
```

---

## 💡 详细功能说明

### 1. 多角色配音系统

#### 配置面板界面

```
┌─────────────────────────────────────────┐
│   🎙️ 配音配置 - 当前角色名             │
├─────────────────────────────────────────┤
│  [输入新角色名] [+添加]                 │
│  [📥 导入全部] [📂 导出全部]            │
├─────────────────────────────────────────┤
│  角色1              [拖拽上传或点击]    │
│  角色2              [已配置: voice.wav]  │
│  ...                                    │
├─────────────────────────────────────────┤
│  [取消]                          [保存]  │
└─────────────────────────────────────────┘
```

#### 配置步骤

1. **添加角色**：
   - 在输入框中输入角色名（如"艾米"、"路易"）
   - 点击 ➕ **添加** 按钮
   - 新角色会出现在列表中

2. **上传配音文件**：
   - 拖拽 `.wav` / `.mp3` / `.ogg` 文件到对应角色的区域
   - 或点击区域选择文件
   - 文件会自动转码为 WAV 格式

3. **编辑/删除**：
   - 点击 ❌ 删除该角色的配音
   - 重新拖拽上传替换配音

4. **保存**：
   - 所有更改完成后点击 **保存**
   - 配置自动保存到本地存储

#### 配音映射表（VoiceMap）

- 每个聊天角色对应一个独立的 VoiceMap
- 格式：`{ [角色名]: "voice_file.wav" }`
- 自动创建和更新
- 支持导入/导出为 JSON 格式

### 2. 文本解析模式

#### GAL 模式（默认）

仅朗读包含 VN 格式标记的对话行。

**支持的格式**：

```
[角色|表情]|「对话」      → [角色|表情] 朗读 「对话」
[旁白]|描述               → [旁白] 朗读 描述
[角色][表情]对话         → [角色] 朗读 对话
[角色]对话               → [角色] 朗读 对话
```

**示例**：

```
消息内容：
[艾米|微笑]|「你好呀！」
[旁白]|她转过身去
[路易]「没什么，只是在想。」

播放效果：
✓ 艾米：「你好呀！」
✗ （旁白描述不播放）
✓ 路易：「没什么，只是在想。」
```

#### 听书模式（Audiobook）

朗读整个消息内容，忽略格式标记。

**特点**：
- 适合故事性对话
- 全文逐句播放
- 支持完整的叙述性文本

**示例**：

```
消息内容：
[艾米|微笑]|「你好呀！」
她转身看向窗外。
[路易]「没什么。」

播放效果：
✓ 艾米：「你好呀！」
✓ 她转身看向窗外。
✓ 路易：「没什么。」
```

#### 模式切换

设置面板 → **解析模式** → 选择 **GAL 模式** 或 **听书模式** → 保存

### 3. 行内播放增强

#### 启用条件

- 设置面板中 **启用行内增强渲染** 为勾选状态

#### 显示效果

每条 VN 格式的对话末尾会出现一个小播放按钮 🔘：

```
[艾米]「你好呀！」 🔘
```

#### 交互方式

- **悬停**：按钮变大，颜色变亮
- **点击**：播放该句对话
- **长按**：呼出播放器（可选）

#### 禁用方法

设置面板 → **启用行内增强渲染** → 取消勾选 → 保存

### 4. 迷你播放器（Mini Player）

#### 自动呼出

- 点击消息的任何播放按钮时自动显示
- 显示在按钮下方，浮动显示

#### 界面组成

```
┌────────────────────────────────────────┐
│ ⏯  ──●────── 0:45 / 2:30   1.0x      │
└────────────────────────────────────────┘
```

| 组件 | 功能 |
|------|------|
| ⏯️ | 播放/暂停 |
| 进度条 | 拖拽调整播放位置 |
| 时间显示 | 当前位置 / 总长度 |
| 倍速 | 点击悬停可调节播放速度 |

#### 倍速调节

1. **鼠标悬停** 在 `1.0x` 倍速显示区
2. 上方会弹出 **竖向滑块**
3. 拖拽调节范围：`0.25x ~ 5.0x`
4. 实时播放倍速变化

#### 自动隐藏

- 鼠标离开迷你播放器 200ms 后自动隐藏
- 重新点击播放按钮重新显示

### 5. 音频缓存系统

#### 缓存机制

1. **内存缓存**（优先）
   - 当前会话的音频文件
   - 消息重新加载时清空

2. **IndexedDB 数据库**（持久化）
   - 跨会话保存
   - 容量：通常 50MB+
   - 支持导入/导出

#### 缓存键生成

基于以下参数生成唯一哈希：
```
hash = SHA-256(角色 | 音色ID | 速度 | 音量 | 文本)
```

相同输入生成相同哈希，确保缓存一致性。

#### 缓存管理

在设置面板的 **音频缓存管理** 模块：

| 操作 | 说明 |
|------|------|
| 📥 扫描导入 | 从本地目录导入音频文件 |
| 📂 导出备份 | 导出所有缓存音频到本地 |
| 🗑️ 清空全部 | 清除所有缓存（不可撤销） |

#### 本地目录导入

1. 设置 **本地缓存目录** 路径
   - 示例：`\\192.168.1.100\SillyTavern\data\TTSsound`
   - 支持本地路径和网络路径

2. 点击 **📥 扫描导入**

3. 系统自动识别文件格式：
   ```
   [角色名]_描述文本_哈希值.wav
   ```

4. 导入成功的文件加载到缓存

#### 缓存导出格式

```
[角色名]_文本预览_哈希值.wav
```

示例：
```
[艾米]_你好呀_a1b2c3.wav
[路易]_没什么_d4e5f6.wav
```

### 6. 音声克隆（Voice Cloning）

#### 工作原理

上传用户的音频样本 → API 处理 → 返回新的语音ID → 用于生成新的配音

#### 使用步骤

1. **准备音频样本**
   - 格式：`.wav`, `.mp3`, `.ogg`
   - 时长：建议 5-30 秒
   - 音质：越清晰越好

2. **打开配置面板**
   - 点击消息下的 ⚙️ **配置** 按钮

3. **选择克隆对象**
   - 在角色列表中找到要克隆的角色
   - 其音频上传区会显示特殊的克隆界面

4. **上传样本**
   - 拖拽或点击选择音频文件
   - 等待处理（显示"克隆中..."）

5. **完成**
   - 克隆完成后显示 ✓ 成功提示
   - 新样本自动成为该角色的配音

#### API 调用

```json
POST /api/v1/indextts2_cloning
Content-Type: application/json

{
  "character_name": "艾米",
  "base64_audio": "SUQzBAAAAAAAI1NTVVNbZXJpZXM..."
}
```

响应：
```json
{
  "success": true,
  "voice_id": "cloned_amy_001",
  "message": "克隆成功"
}
```

### 7. 自动推理功能

#### 启用方式

设置面板 → **播放与自动化** → 勾选 **回复后自动推理** → 保存

#### 工作流程

```
AI 生成回复
    ↓
检测到新消息
    ↓
自动调用推理接口
    ↓
生成语音（带动画提示）
    ↓
自动播放（可选）或静默完成
```

#### 推理状态指示

- **推理中**：按钮显示呼吸动画（绿色闪烁）
- **推理完成**：自动消失，音频已缓存
- **推理失败**：显示错误提示

#### 防止重复推理

- 同一消息的推理操作会被锁定
- 防止多次点击导致重复请求
- 等待当前推理完成后才能开始新的推理

---

## ⚙️ 配置选项

### 设置面板布局

设置面板分为 **3 个模块**：

#### 模块 1：🔌 服务配置

| 选项 | 说明 | 默认值 |
|------|------|--------|
| **TTS 服务地址** | IndexTTS2 文本转语音 API 端点 | `http://127.0.0.1:7880/v1/audio/speech` |
| **音色克隆地址** | 音声克隆 API 端点 | `http://127.0.0.1:7880/api/v1/indextts2_cloning` |
| **推理模型名称** | 发送给 TTS API 的模型参数 | `index-tts2` |

**配置示例**：

如果您的 TTS 服务部署在远程服务器：
```
TTS 服务地址: http://192.168.1.100:7880/v1/audio/speech
音色克隆地址: http://192.168.1.100:7880/api/v1/indextts2_cloning
```

#### 模块 2：▶ 播放与自动化

| 选项 | 说明 | 默认值 |
|------|------|--------|
| **解析模式** | 文本解析方式（GAL / 听书） | `gal` |
| **启用行内增强渲染** | 在对话文本中注入播放按钮 | ✓ 启用 |
| **回复后自动推理** | 收到回复后自动生成语音 | ✗ 禁用 |
| **默认朗读音色** | 当角色无配音时的备用音色文件 | `default.wav` |
| **默认速度** | 初始播放速度（倍数） | `1.0` |
| **全局音量** | 初始播放音量（0.0 ~ 1.0） | `1.0` |

**配置示例**：

```
解析模式: 听书模式
启用行内增强渲染: ✓
回复后自动推理: ✓
默认朗读音色: narrator.wav
默认速度: 1.2
全局音量: 0.8
```

#### 模块 3：💾 音频缓存管理

| 选项 | 说明 | 默认值 |
|------|------|--------|
| **本地缓存目录** | 扫描导入音频文件的目录路径 | `\\SillyTavern\data\TTSsound` |
| **已缓存音频数** | 实时显示缓存条数 | - |
| **📥 扫描导入** | 从本地目录导入音频 | - |
| **📂 导出备份** | 导出所有缓存到本地 | - |
| **🗑️ 清空全部** | 删除所有缓存（谨慎！） | - |

**路径示例**：

本地路径：
```
C:\Users\YourName\Documents\SillyTavern\data\TTSsound
```

网络路径：
```
\\192.168.1.100\share\TTSsound
\\nas-server\media\audio
```

### 配置持久化

- 所有设置自动保存到 `window.extension_settings['st-indextts2']`
- 刷新页面后自动恢复
- 每个聊天角色的 VoiceMap 独立保存

### 配置重置

如需重置所有配置：

1. 打开浏览器开发者工具（F12）
2. 进入 **Console** 标签
3. 执行：
   ```javascript
   delete window.extension_settings['st-indextts2'];
   window.saveSettingsDebounced?.();
   location.reload();
   ```

---

## 📝 使用示例

### 场景 1：简单对话配音

**聊天内容**：
```
AI: [艾米]「你好，今天怎么样？」
```

**配置**：
1. 打开配置面板 ⚙️
2. 添加角色"艾米"，上传其语音文件 `amy_voice.wav`
3. 保存

**播放**：
1. 点击 🔊 **播放整楼层**
2. 或点击行内的小播放按钮
3. 迷你播放器出现，可调整倍速和音量

---

### 场景 2：复杂叙述性文本

**聊天内容**：
```
AI: [艾米|温柔]|「月亮很圆，不是吗？」
静静的夜晚，只有风声。
[路易]「是啊，很美。」
他靠近窗户，看向远方。
```

**配置**：
1. 切换解析模式为 **听书模式**
2. 添加角色"艾米"和"路易"，上传各自语音
3. 保存

**播放**：
1. 点击 🔊，系统自动按顺序播放所有台词
2. 使用迷你播放器控制进度

---

### 场景 3：自动生成和播放

**设置**：
- 勾选 **回复后自动推理** 选项

**工作流**：
1. 用户提问
2. AI 生成回复后，按钮自动显示推理中状态 ✨💫
3. 推理完成，语音自动生成并缓存
4. 用户点击 🔊 立即播放，无需等待

---

### 场景 4：导入本地音频库

**前提**：有本地音频文件库（如 `.wav` 文件夹）

**步骤**：
1. 在设置面板中设置 **本地缓存目录**
   ```
   \\NAS\media\tts_audio
   ```

2. 点击 **📥 扫描导入**

3. 系统自动读取目录，按格式识别：
   ```
   [角色名]_描述_哈希.wav
   ```

4. 识别成功的文件自动加载到 IndexedDB

5. 后续播放时直接使用缓存，无需重新生成

---

## 🔌 API 文档

### 全局对象：`window.IndexTTS`

扩展暴露的全局 API，供外部脚本或 iframe 调用。

#### 方法列表

##### 1. `play(text, voice, character, context)`

**功能**：播放指定文本的语音

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `text` | string | ✓ | 要转换的文本 |
| `voice` | string | ✗ | 语音文件名（如 `voice.wav`） |
| `character` | string | ✗ | 角色名称 |
| `context` | object | ✗ | 上下文信息 |

**context 对象结构**：

```javascript
{
  msg: Element,           // DOM 消息节点
  mesId: string,          // 消息 ID
  encT: string,           // 编码后的文本（Base64）
  encC: string            // 编码后的角色名（Base64）
}
```

**示例**：

```javascript
// 简单播放
window.IndexTTS.play('你好世界', 'voice.wav', '艾米');

// 带 context 播放
const msg = document.querySelector('.mes');
window.IndexTTS.play(
  '你好世界',
  'voice.wav',
  '艾米',
  { msg: msg, mesId: 'msg_001' }
);
```

##### 2. `getSettings()`

**功能**：获取当前配置对象

**返回值**：

```javascript
{
  apiUrl: 'http://127.0.0.1:7880/v1/audio/speech',
  cloningUrl: 'http://127.0.0.1:7880/api/v1/indextts2_cloning',
  model: 'index-tts2',
  defaultVoice: 'default.wav',
  speed: 1.0,
  volume: 1.0,
  parsingMode: 'gal',           // 'gal' | 'audiobook'
  enableInline: true,
  autoInference: false,
  cacheImportPath: '\\...',
  voiceMap: {
    [cardId]: {
      'character_name': 'voice_file.wav'
    }
  }
}
```

**示例**：

```javascript
const settings = window.IndexTTS.getSettings();
console.log(`TTS 地址: ${settings.apiUrl}`);
console.log(`当前速度: ${settings.speed}x`);
```

##### 3. `getVoiceMap()`

**功能**：获取当前聊天角色的配音映射表

**返回值**：

```javascript
{
  'character_name1': 'voice1.wav',
  'character_name2': 'voice2.wav',
  ...
}
```

**示例**：

```javascript
const voiceMap = window.IndexTTS.getVoiceMap();
if (voiceMap['艾米']) {
  console.log(`艾米的配音: ${voiceMap['艾米']}`);
}
```

##### 4. `parseVNLine(text)`

**功能**：解析单行文本是否为 VN 格式，并提取角色和对话

**参数**：

| 参数 | 类型 | 说明 |
|------|------|------|
| `text` | string | 待解析的文本行 |

**返回值**：

```javascript
{
  character: string,    // 角色名
  dialogue: string,     // 对话内容
  format: string        // 匹配的格式（'quote' | 'bracket' 等）
}
```

或 `null`（若不符合 VN 格式）

**示例**：

```javascript
const result = window.IndexTTS.parseVNLine('[艾米|微笑]|「你好！」');
if (result) {
  console.log(`角色: ${result.character}`);  // 艾米
  console.log(`对话: ${result.dialogue}`);   // 你好！
}
```

##### 5. `getCardId()`

**功能**：获取当前聊天的角色 ID

**返回值**：string（角色 ID，默认为 `'default'`）

**示例**：

```javascript
const cardId = window.IndexTTS.getCardId();
console.log(`当前角色 ID: ${cardId}`);
```

### TTS API 规范

#### 文本转语音接口

**端点**：`POST {apiUrl}`

**请求体**：

```json
{
  "model": "index-tts2",
  "input": "你好，世界",
  "voice": "default.wav",
  "response_format": "wav",
  "speed": 1.0
}
```

**响应**：

```
Content-Type: audio/wav
[二进制音频数据]
```

**状态码**：

| 代码 | 说明 |
|------|------|
| 200 | 成功，返回 WAV 音频 |
| 400 | 请求参数错误 |
| 500 | 服务器错误 |

#### 音声克隆接口

**端点**：`POST {cloningUrl}`

**请求体**：

```json
{
  "character_name": "艾米",
  "base64_audio": "SUQzBAAAAAAAI1NTVVNbZXJpZXM=..."
}
```

**响应**：

```json
{
  "success": true,
  "voice_id": "cloned_amy_001",
  "message": "克隆成功"
}
```

或

```json
{
  "success": false,
  "message": "音频格式不支持"
}
```

---

## ❓ 常见问题

### Q1: 为什么点击播放没有声音？

**可能原因**：

1. ❌ TTS 服务不可用
   - 检查服务地址是否正确
   - 确认 IndexTTS2 服务已启动
   - 检查网络连接

2. ❌ 浏览器音量过低
   - 检查系统音量
   - 检查浏览器标签音量
   - 检查网页音量设置

3. ❌ 角色未配置配音
   - 打开配置面板检查是否添加了角色
   - 确认上传了语音文件

**解决步骤**：

```javascript
// 在浏览器控制台检查
const settings = window.IndexTTS.getSettings();
console.log('API URL:', settings.apiUrl);
console.log('Volume:', settings.volume);
```

---

### Q2: 导入本地音频为什么失败？

**可能原因**：

1. ❌ 目录路径不正确
   - 确认路径存在且可访问
   - 使用绝对路径，避免相对路径

2. ❌ 文件格式不匹配
   - 检查文件后缀（`.wav`, `.mp3`, `.ogg`）
   - 检查文件名是否符合格式：`[角色]_描述_哈希.wav`

3. ❌ 权限不足
   - 确认有读取权限
   - 网络路径需要正确认证

**示例正确格式**：

```
[艾米]_你好_a1b2c3.wav
[路易]_晚上好_d4e5f6.mp3
[旁白]_场景描述_g7h8i9.ogg
```

---

### Q3: 推理速度很慢怎么办？

**优化建议**：

1. **启用缓存**
   - 相同内容不会重复生成
   - 启用 IndexedDB 缓存
   - 定期导出备份

2. **批量预生成**
   - 使用"先推理后播放"功能
   - 在后台生成常用对话

3. **调整网络**
   - 使用本地 TTS 服务（更快）
   - 检查 API 服务性能

---

### Q4: 迷你播放器如何关闭？

迷你播放器会自动在以下情况关闭：

- 音频播放完毕
- 点击播放另一段音频
- 鼠标离开 200ms 自动隐藏（可手动重新打开）

**手动关闭**：

点击迷你播放器右上角的关闭按钮（如有）或等待自动隐藏。

---

### Q5: 能否同时播放多个音频？

**当前行为**：

- 同一时间只能播放一个音频
- 点击新音频会停止当前播放

**设计原因**：

- 多个音频同时播放会造成混乱
- 方便了迷你播放器的集中管理

---

## 🔧 故障排除

### 问题排查清单

- [ ] 扩展已启用（检查扩展管理面板）
- [ ] TTS 服务正常运行（`curl http://api:7880/v1/audio/speech`）
- [ ] API 地址正确（检查设置面板）
- [ ] 角色已配置（打开配置面板查看）
- [ ] 网络连接正常（检查浏览器网络标签）
- [ ] 浏览器音量未静音

### 查看日志

打开浏览器开发者工具（F12），查看 **Console** 标签中的错误信息：

```javascript
// 常见错误信息说明
"[IndexTTS2] [API Request] hash_xxx"        // 正在请求 API
"[IndexTTS2] API Error: 404"                 // API 地址错误
"[IndexTTS2] Clone: ..., base64 len=..."     // 克隆音频处理中
```

### 常见错误信息

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| **CORS Error** | 跨域请求被阻止 | 检查 TTS 服务 CORS 配置 |
| **404 Not Found** | API 地址错误 | 检查和更正 API 端点 |
| **Timeout** | API 响应超时 | 检查网络和服务性能 |
| **IndexedDB Error** | 数据库访问失败 | 清除浏览器缓存重试 |

### 完全重置

如果出现异常情况，可以完全重置扩展：

```javascript
// 在控制台执行
// 1. 清除配置
delete window.extension_settings['st-indextts2'];

// 2. 清除缓存
indexedDB.deleteDatabase('AudioStorage');

// 3. 保存和刷新
window.saveSettingsDebounced?.();
setTimeout(() => location.reload(), 500);
```

---

## 📚 高级用法

### 自定义 TTS 服务对接

如果要使用非 IndexTTS2 的 TTS 服务，需要修改 API 接口。

编辑 `index.js` 中的 `ensureAudioRecord` 函数：

```javascript
// 约第 510-546 行
// 修改 payload 结构以适配你的 API
const payload = {
  model: settings.model,
  input: text,
  voice: normVoice,
  response_format: 'wav',
  speed: speed,
  // 添加其他参数...
};

// 修改请求处理逻辑
// ... API 调用代码
```

### 批量批量处理消息

```javascript
// 获取所有消息并逐个推理
document.querySelectorAll('.mes[is_user="false"]').forEach(msg => {
  const inferBtn = msg.querySelector('.indextts-infer');
  if (inferBtn) inferBtn.click();
});
```

### 导出音频数据

```javascript
// 导出所有缓存的音频
const allAudios = await window.AudioStorage.getAllAudios();
allAudios.forEach(record => {
  console.log(`${record.hash}: ${record.blob.size} bytes`);
});
```

---

## 📄 许可证

MIT License

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📞 支持

- **报告 Bug**：在 GitHub 提交 Issue
- **功能建议**：在 Discussions 中讨论
- **文档问题**：提交文档改进 PR

---

## 更新日志

### v1.0.0 (2026-02-06)

- ✨ 首次发布
- 🎙️ 多角色智能配音
- 🔊 灵活的文本解析模式（GAL / 听书）
- ⚡ 行内播放增强和迷你播放器
- 💾 IndexedDB 音频缓存系统
- 🎯 自动推理和批量导入功能
- 🔧 完整的 API 接口

---

**感谢使用 IndexTTS2 Player! 🎉**
